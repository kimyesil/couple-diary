<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìš°ë¦¬ ë‘˜ì˜ ê¸°ë¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #ffeaf4, #eaf6ff);
      --card-bg: #ffffffcc;
      --accent: #ff8aa8;
      --accent-soft: #ffe0ea;
      --accent-strong: #ff5c85;
      --text-main: #333;
      --text-sub: #777;
      --radius-xl: 24px;
      --shadow-soft: 0 12px 25px rgba(0,0,0,0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      max-width: 960px;
      padding: 20px 16px 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 12px;
    }

    .logo-area {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .logo-title {
      font-size: 26px;
      font-weight: 800;
      letter-spacing: -0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-title span.emoji {
      font-size: 22px;
    }

    .logo-sub {
      font-size: 13px;
      color: var(--text-sub);
    }

    .dday-pill {
      margin-top: 4px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,0.8);
      border-radius: 999px;
      padding: 4px 10px;
      color: var(--accent-strong);
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .primary-btn {
      border: none;
      cursor: pointer;
      padding: 10px 18px;
      border-radius: 999px;
      background: var(--accent);
      color: white;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 8px 16px rgba(255,92,133,0.35);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
      white-space: nowrap;
    }

    .primary-btn:hover {
      transform: translateY(-1px);
      background: var(--accent-strong);
      box-shadow: 0 10px 20px rgba(255,92,133,0.45);
    }

    .primary-btn:active {
      transform: translateY(0);
      box-shadow: 0 6px 12px rgba(255,92,133,0.25);
    }

    .primary-btn span.icon {
      font-size: 16px;
    }

    main {
      background: #ffffffdd;
      border-radius: var(--radius-xl);
      padding: 18px 18px 24px;
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(10px);
    }

    /* ë·° ê³µí†µ */
    .view {
      display: none;
      animation: fadeIn 0.2s ease-out;
    }
    .view.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ê²Œì‹œíŒ ìƒë‹¨ */
    .board-header {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }

    .board-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .board-title {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .board-title-tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-weight: 600;
    }

    .board-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }

    .search-box {
      flex: 1 1 200px;
      display: flex;
      align-items: center;
      gap: 6px;
      background: #f7f7fb;
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid #e0e0f0;
    }

    .search-box span {
      font-size: 14px;
    }

    .search-input {
      border: none;
      background: transparent;
      outline: none;
      font-size: 13px;
      width: 100%;
    }

    .view-toggle {
      display: flex;
      border-radius: 999px;
      background: #f5f5ff;
      padding: 2px;
      border: 1px solid #e0e0f5;
      gap: 2px;
    }

    .toggle-btn {
      font-size: 12px;
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      background: transparent;
      cursor: pointer;
      color: #888;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .toggle-btn.active {
      background: white;
      color: var(--accent-strong);
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    /* ê²Œì‹œíŒ ë¦¬ìŠ¤íŠ¸ */
    .post-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 14px;
      margin-top: 6px;
    }

    .empty-text {
      font-size: 14px;
      color: var(--text-sub);
      padding: 28px 10px 20px;
      text-align: center;
    }

    .post-card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 10px 12px 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.06);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.1s ease;
      border: 1px solid rgba(255,255,255,0.8);
    }

    .post-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 14px 24px rgba(0,0,0,0.08);
      background: #ffffff;
    }

    .post-card-title {
      font-size: 15px;
      font-weight: 700;
      line-height: 1.3;
    }

    .post-card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-sub);
    }

    .post-card-snippet {
      font-size: 13px;
      color: #555;
      line-height: 1.4;
      max-height: 3.1em;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .thumb-strip {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }

    .thumb-strip img {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #fff;
      flex-shrink: 0;
    }

    .thumb-count-badge {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(0,0,0,0.05);
      align-self: flex-end;
      margin-left: auto;
    }

    .card-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 4px;
    }

    .mini-btn {
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      padding: 3px 8px;
      cursor: pointer;
      color: #555;
      transition: background 0.1s ease, border-color 0.1s ease, transform 0.05s ease;
    }

    .mini-btn:hover {
      background: #f7f7f7;
      border-color: #ccc;
      transform: translateY(-1px);
    }

    .mini-btn.delete {
      border-color: #ffc1c1;
      color: #d95353;
      background: #fff7f7;
    }

    .mini-btn.delete:hover {
      background: #ffe2e2;
      border-color: #ffaaaa;
    }

    /* ì—°ë„ë³„ íƒ€ì„ë¼ì¸ */
    .timeline-list {
      margin-top: 12px;
    }

    .timeline-year-block {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px 14px;
      margin-bottom: 18px;
    }

    .timeline-year-label {
      font-weight: 800;
      font-size: 16px;
      color: var(--accent-strong);
      padding-top: 4px;
    }

    .timeline-items {
      border-left: 2px solid #ffd0df;
      padding-left: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .timeline-item {
      position: relative;
      padding: 6px 10px 8px;
      background: #fffdfd;
      border-radius: 14px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.04);
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.9);
    }

    .timeline-item::before {
      content: "";
      position: absolute;
      left: -16px;
      top: 10px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ff9ab5;
      box-shadow: 0 0 0 4px #ffe5f0;
    }

    .timeline-item-date {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .timeline-item-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .timeline-item-snippet {
      font-size: 12px;
      color: #555;
      max-height: 2.5em;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ê¸€ì“°ê¸° í¼ */
    .form-section-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .back-link {
      font-size: 13px;
      color: var(--text-sub);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 8px;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      display: inline-block;
    }

    input[type="text"],
    textarea,
    input[type="date"] {
      width: 100%;
      border-radius: 14px;
      border: 1px solid #e0e0e0;
      padding: 9px 11px;
      font-size: 14px;
      resize: vertical;
      min-height: 44px;
      outline: none;
      transition: border 0.1s ease, box-shadow 0.1s ease;
      background: #fafbff;
    }

    textarea {
      min-height: 160px;
      line-height: 1.5;
    }

    input[type="text"]:focus,
    textarea:focus,
    input[type="date"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px #ffe0ec;
      background: #ffffff;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .hint-text {
      font-size: 11px;
      color: var(--text-sub);
    }

    input[type="file"] {
      font-size: 12px;
    }

    .form-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .form-footer-left {
      font-size: 12px;
      color: var(--text-sub);
    }

    .form-footer-right {
      display: flex;
      gap: 8px;
    }

    .secondary-btn {
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 13px;
      padding: 8px 14px;
      cursor: pointer;
      color: #555;
      transition: background 0.1s ease, border-color 0.1s ease;
    }

    .secondary-btn:hover {
      background: #f7f7f7;
      border-color: #ccc;
    }

    /* ìƒì„¸ ë³´ê¸° */
    .post-detail-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 14px;
    }

    .post-detail-title {
      font-size: 20px;
      font-weight: 800;
      line-height: 1.4;
    }

    .post-detail-meta {
      font-size: 12px;
      color: var(--text-sub);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .post-detail-content {
      font-size: 14px;
      line-height: 1.7;
      white-space: pre-wrap;
      word-break: break-word;
      margin-bottom: 14px;
    }

    .post-detail-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 8px;
    }

    .post-detail-images img {
      width: 100%;
      border-radius: 14px;
      object-fit: cover;
      max-height: 260px;
      cursor: zoom-in;
    }

    .detail-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* ì´ë¯¸ì§€ ëª¨ë‹¬ */
    .image-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }

    .image-modal-overlay.active {
      display: flex;
    }

    .image-modal-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      background: #000;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      overflow: hidden;
    }

    .image-modal-content img {
      display: block;
      max-width: 100%;
      max-height: 90vh;
      object-fit: contain;
    }

    .image-modal-close {
      position: absolute;
      top: 8px;
      right: 10px;
      border: none;
      background: rgba(0,0,0,0.5);
      color: #fff;
      border-radius: 999px;
      padding: 4px 9px;
      cursor: pointer;
      font-size: 14px;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }

      main {
        padding: 14px 12px 20px;
        border-radius: 18px;
      }

      .post-list {
        grid-template-columns: 1fr;
      }

      .timeline-year-block {
        grid-template-columns: 1fr;
      }

      .timeline-year-label {
        padding-top: 0;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="logo-area">
        <div class="logo-title">
          <span class="emoji">ğŸ’Œ</span>
          <span>ìš°ë¦¬ ë‘˜ì˜ ê¸°ë¡</span>
        </div>
        <div class="logo-sub">ë§¤ì¼ë§¤ì¼, ìš°ë¦¬ ì¼ìƒ ì‘ì€ ì¡°ê°ë“¤</div>
        <div class="dday-pill" id="ddayBox"></div>
      </div>
      <button class="primary-btn" id="newPostBtn">
        <span class="icon">âœï¸</span>
        <span>ìƒˆ ê¸€ ì“°ê¸°</span>
      </button>
    </header>

    <main>
      <!-- ê²Œì‹œíŒ ë¦¬ìŠ¤íŠ¸ -->
      <section id="listView" class="view active">
        <div class="board-header">
          <div class="board-title-row">
            <div class="board-title">
              ğŸ“’ ì˜¤ëŠ˜ê¹Œì§€ì˜ ê¸°ë¡
              <span class="board-title-tag" id="postCountTag">0ê°œì˜ ì´ì•¼ê¸°ê°€ ìˆì–´ìš”</span>
            </div>
          </div>
          <div class="board-controls">
            <div class="search-box">
              <span>ğŸ”</span>
              <input
                id="searchInput"
                class="search-input"
                type="text"
                placeholder="ì œëª©ì´ë‚˜ ë‚´ìš©ìœ¼ë¡œ ê²€ìƒ‰í•˜ê¸°"
              />
            </div>
            <div class="view-toggle">
              <button class="toggle-btn active" data-mode="grid">ğŸ“š ì¹´ë“œ ë·°</button>
              <button class="toggle-btn" data-mode="timeline">ğŸ•° íƒ€ì„ë¼ì¸ ë·°</button>
            </div>
          </div>
        </div>

        <div id="postList" class="post-list"></div>
        <div id="timelineList" class="timeline-list" style="display:none;"></div>

        <div id="emptyState" class="empty-text">
          ì•„ì§ ê¸€ì´ ì—†ì–´ìš”.<br />
          ìƒë‹¨ì˜ <b>ã€Œìƒˆ ê¸€ ì“°ê¸°ã€</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ê¸°ë¡ì„ ë‚¨ê²¨ë³¼ê¹Œ? ğŸ’­
        </div>
      </section>

      <!-- ê¸€ì“°ê¸° -->
      <section id="editorView" class="view">
        <div class="back-link" data-back="list">
          <span>â†</span><span>ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
        </div>
        <div class="form-section-title">
          âœ¨ ìƒˆ ê¸°ë¡ ë‚¨ê¸°ê¸°
        </div>
        <form id="postForm">
          <div class="field-group">
            <label for="titleInput">ì œëª©</label>
            <input id="titleInput" type="text" placeholder="ì˜ˆ) ìš°ë¦¬ ì²« ëˆˆ ì˜¨ ë‚  ë°ì´íŠ¸ ğŸ’•" required />
          </div>

          <div class="field-group">
            <label for="dateInput">ë‚ ì§œ</label>
            <input id="dateInput" type="date" required />
            <div class="hint-text">
              ì‹¤ì œë¡œ ìˆì—ˆë˜ ë‚ ì§œë¥¼ ì„ íƒí•´ì¤˜ (ê¸°ë³¸ì€ ì˜¤ëŠ˜ì´ì•¼!)
            </div>
          </div>

          <div class="field-group">
            <label for="contentInput">ë‚´ìš©</label>
            <textarea id="contentInput" placeholder="ê·¸ ë‚ ì˜ ë¶„ìœ„ê¸°, ëŒ€í™”, ê°ì •ë“¤ì„ ììœ ë¡­ê²Œ ì ì–´ì¤˜ :)" required></textarea>
          </div>

          <div class="field-group">
            <label for="imageInput">ì‚¬ì§„ ì—…ë¡œë“œ</label>
            <input id="imageInput" type="file" accept="image/*" multiple />
            <div class="hint-text">
              ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥í•´ìš”. (ì‚¬ì§„ì€ ì´ ë¸Œë¼ìš°ì € ì•ˆì—ë§Œ ì €ì¥ë˜ê³ , ì–´ë””ë¡œë„ ì „ì†¡ë˜ì§€ ì•Šì•„ìš”!)<br />
              ìˆ˜ì • ì‹œ, ì‚¬ì§„ì„ ë‹¤ì‹œ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ ì‚¬ì§„ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë¼ìš”.
            </div>
          </div>

          <div class="form-footer">
            <div class="form-footer-left" id="todayInfo"></div>
            <div class="form-footer-right">
              <button class="secondary-btn" type="button" id="cancelBtn">ì·¨ì†Œ</button>
              <button class="primary-btn" type="submit">
                <span class="icon">ğŸ’¾</span>
                <span>ì €ì¥í•˜ê¸°</span>
              </button>
            </div>
          </div>
        </form>
      </section>

      <!-- ìƒì„¸ ë³´ê¸° -->
      <section id="detailView" class="view">
        <div class="back-link" data-back="list">
          <span>â†</span><span>ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
        </div>
        <div class="post-detail-header">
          <div class="post-detail-title" id="detailTitle"></div>
          <div class="post-detail-meta">
            <span id="detailDate"></span>
            <span id="detailImageCount"></span>
          </div>
        </div>
        <div class="post-detail-content" id="detailContent"></div>
        <div class="post-detail-images" id="detailImages"></div>
        <div class="detail-toolbar">
          <span id="detailCreatedInfo"></span>
          <button class="secondary-btn" type="button" id="detailToEditorBtn">ì´ ê¸€ê³¼ ë¹„ìŠ·í•œ ê¸€ ì“°ê¸°</button>
        </div>
      </section>
    </main>
  </div>

  <!-- ì‚¬ì§„ í™•ëŒ€ ëª¨ë‹¬ -->
  <div id="imageModal" class="image-modal-overlay">
    <div class="image-modal-content">
      <button class="image-modal-close" id="imageModalClose">âœ•</button>
      <img id="imageModalImg" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€" />
    </div>
  </div>

  <script>
    // ======== ê°„ë‹¨ ìœ í‹¸ ========
    function formatDate(date) {
      const d = (date instanceof Date) ? date : new Date(date);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}.${m}.${day}`;
    }

    function getTodayLabel() {
      const d = new Date();
      const weekdays = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
      return `${formatDate(d)} (${weekdays[d.getDay()]})`;
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function dateToInputValue(d) {
      const dt = (d instanceof Date) ? d : new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth() + 1).padStart(2, "0");
      const day = String(dt.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function todayInputValue() {
      return dateToInputValue(new Date());
    }

    // ======== D-day ê³„ì‚° ========
    // â­ ì—¬ê¸°ì—ì„œ ì—°ë„ë¥¼ ë„ˆë„¤ ê¸°ë…ì¼ ì—°ë„ë¡œ ë°”ê¾¸ë©´ ë¨!
    const ANNIV_BASE = new Date(2023, 6, 9); // 2024-07-09 (ì›”ì€ 0ë¶€í„° ì‹œì‘ì´ë¼ 6ì´ 7ì›”)

    function calcDDay(baseDate) {
      const today = new Date();
      const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const b = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
      const diffDays = Math.floor((t - b) / (1000 * 60 * 60 * 24)) + 1; // ì²«ë‚  D+1
      return diffDays;
    }

    function updateDDayBox() {
      const ddayBox = document.getElementById("ddayBox");
      if (!ddayBox) return;
      const days = calcDDay(ANNIV_BASE);
      const dateStr = `${ANNIV_BASE.getFullYear()}.${String(ANNIV_BASE.getMonth() + 1).padStart(2,"0")}.${String(ANNIV_BASE.getDate()).padStart(2,"0")}`;
      if (days >= 1) {
        ddayBox.textContent = `ğŸ’— D+${days} (since ${dateStr})`;
      } else {
        ddayBox.textContent = `ğŸ’— D${days} (since ${dateStr})`;
      }
    }

    // ======== ìƒíƒœ ê´€ë¦¬ (localStorage) ========
    const STORAGE_KEY = "couple_diary_posts_v1";
    let posts = [];
    let currentSearch = "";
    let currentListMode = "grid"; // "grid" | "timeline"
    let editingPostId = null;

    function loadPosts() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      } catch (e) {
        console.error("loadPosts error:", e);
        return [];
      }
    }

    function savePosts() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(posts));
    }

    function getFilteredPosts() {
      if (!currentSearch.trim()) return posts;
      const keyword = currentSearch.trim().toLowerCase();
      return posts.filter(p => {
        return (
          (p.title || "").toLowerCase().includes(keyword) ||
          (p.content || "").toLowerCase().includes(keyword)
        );
      });
    }

    // ======== DOM ì°¸ì¡° ========
    const listView = document.getElementById("listView");
    const editorView = document.getElementById("editorView");
    const detailView = document.getElementById("detailView");

    const postListEl = document.getElementById("postList");
    const timelineListEl = document.getElementById("timelineList");
    const emptyStateEl = document.getElementById("emptyState");
    const postCountTag = document.getElementById("postCountTag");

    const newPostBtn = document.getElementById("newPostBtn");
    const postForm = document.getElementById("postForm");
    const titleInput = document.getElementById("titleInput");
    const dateInput = document.getElementById("dateInput");
    const contentInput = document.getElementById("contentInput");
    const imageInput = document.getElementById("imageInput");
    const todayInfo = document.getElementById("todayInfo");
    const cancelBtn = document.getElementById("cancelBtn");

    const detailTitle = document.getElementById("detailTitle");
    const detailDate = document.getElementById("detailDate");
    const detailImageCount = document.getElementById("detailImageCount");
    const detailContent = document.getElementById("detailContent");
    const detailImages = document.getElementById("detailImages");
    const detailCreatedInfo = document.getElementById("detailCreatedInfo");
    const detailToEditorBtn = document.getElementById("detailToEditorBtn");

    const backLinks = document.querySelectorAll(".back-link");

    const searchInput = document.getElementById("searchInput");
    const toggleButtons = document.querySelectorAll(".toggle-btn");

    const imageModal = document.getElementById("imageModal");
    const imageModalImg = document.getElementById("imageModalImg");
    const imageModalClose = document.getElementById("imageModalClose");

    // ======== ë·° ì „í™˜ ========
    function showView(name) {
      [listView, editorView, detailView].forEach(v => v.classList.remove("active"));
      if (name === "list") listView.classList.add("active");
      if (name === "editor") editorView.classList.add("active");
      if (name === "detail") detailView.classList.add("active");
    }

    // ======== ì´ë¯¸ì§€ ëª¨ë‹¬ ========
    function openImageModal(src) {
      imageModalImg.src = src;
      imageModal.classList.add("active");
    }

    function closeImageModal() {
      imageModal.classList.remove("active");
      imageModalImg.src = "";
    }

    imageModalClose.addEventListener("click", closeImageModal);
    imageModal.addEventListener("click", (e) => {
      if (e.target === imageModal) {
        closeImageModal();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && imageModal.classList.contains("active")) {
        closeImageModal();
      }
    });

    // ======== ê²Œì‹œíŒ ë Œë”ë§ (ì¹´ë“œ ë·°) ========
    function renderList() {
      const filtered = getFilteredPosts();
      postListEl.innerHTML = "";
      const hasPosts = filtered.length > 0;
      emptyStateEl.style.display = hasPosts ? "none" : "block";

      if (currentSearch.trim()) {
        postCountTag.textContent = `${filtered.length}ê°œì˜ ê²€ìƒ‰ ê²°ê³¼ (ì „ì²´ ${posts.length}ê°œ)`;
      } else {
        postCountTag.textContent = hasPosts
          ? `${posts.length}ê°œì˜ ì´ì•¼ê¸°ê°€ ìˆì–´ìš”`
          : "0ê°œì˜ ì´ì•¼ê¸°ê°€ ìˆì–´ìš”";
      }

      if (!hasPosts) return;

      filtered.forEach(post => {
        const card = document.createElement("article");
        card.className = "post-card";

        const titleEl = document.createElement("div");
        titleEl.className = "post-card-title";
        titleEl.textContent = post.title;

        const metaEl = document.createElement("div");
        metaEl.className = "post-card-meta";
        const dateSpan = document.createElement("span");
        dateSpan.textContent = formatDate(post.date || post.createdAt);
        const imagesSpan = document.createElement("span");
        imagesSpan.textContent = post.images && post.images.length
          ? `ğŸ“· ${post.images.length}ì¥`
          : "í…ìŠ¤íŠ¸ ê¸°ë¡";
        metaEl.appendChild(dateSpan);
        metaEl.appendChild(imagesSpan);

        const snippetEl = document.createElement("div");
        snippetEl.className = "post-card-snippet";
        snippetEl.textContent = post.content.length > 80
          ? post.content.slice(0, 80) + "..."
          : post.content;

        card.appendChild(titleEl);
        card.appendChild(metaEl);
        card.appendChild(snippetEl);

        if (post.images && post.images.length > 0) {
          const strip = document.createElement("div");
          strip.className = "thumb-strip";

          post.images.slice(0, 3).forEach(src => {
            const img = document.createElement("img");
            img.src = src;
            strip.appendChild(img);
          });

          if (post.images.length > 3) {
            const badge = document.createElement("div");
            badge.className = "thumb-count-badge";
            badge.textContent = `+${post.images.length - 3}`;
            strip.appendChild(badge);
          }

          card.appendChild(strip);
        }

        // ìˆ˜ì • / ì‚­ì œ ë²„íŠ¼
        const actions = document.createElement("div");
        actions.className = "card-actions";

        const editBtn = document.createElement("button");
        editBtn.className = "mini-btn";
        editBtn.textContent = "ìˆ˜ì •";
        editBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          startEdit(post);
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "mini-btn delete";
        deleteBtn.textContent = "ì‚­ì œ";
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (confirm("ì •ë§ ì´ ê¸€ì„ ì‚­ì œí• ê¹Œìš”?")) {
            posts = posts.filter(p => p.id !== post.id);
            savePosts();
            renderList();
            renderTimeline();
          }
        });

        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
        card.appendChild(actions);

        card.addEventListener("click", () => openDetail(post.id));
        postListEl.appendChild(card);
      });
    }

    // ======== ì—°ë„ë³„ íƒ€ì„ë¼ì¸ ë Œë”ë§ ========
    function renderTimeline() {
      const filtered = getFilteredPosts();
      timelineListEl.innerHTML = "";
      const hasPosts = filtered.length > 0;
      emptyStateEl.style.display = hasPosts ? "none" : "block";

      if (!hasPosts) return;

      const byYear = {};
      filtered.forEach(post => {
        const d = new Date(post.date || post.createdAt);
        const year = d.getFullYear();
        if (!byYear[year]) byYear[year] = [];
        byYear[year].push(post);
      });

      const years = Object.keys(byYear)
        .map(y => parseInt(y, 10))
        .sort((a, b) => b - a);

      years.forEach(year => {
        const block = document.createElement("div");
        block.className = "timeline-year-block";

        const label = document.createElement("div");
        label.className = "timeline-year-label";
        label.textContent = `${year}`;

        const itemsWrap = document.createElement("div");
        itemsWrap.className = "timeline-items";

        const postsOfYear = byYear[year].sort(
          (a, b) => (b.date || b.createdAt) - (a.date || a.createdAt)
        );

        postsOfYear.forEach(post => {
          const item = document.createElement("div");
          item.className = "timeline-item";

          const dateEl = document.createElement("div");
          dateEl.className = "timeline-item-date";
          dateEl.textContent = formatDate(post.date || post.createdAt);

          const titleEl = document.createElement("div");
          titleEl.className = "timeline-item-title";
          titleEl.textContent = post.title;

          const snippetEl = document.createElement("div");
          snippetEl.className = "timeline-item-snippet";
          snippetEl.textContent = post.content.length > 60
            ? post.content.slice(0, 60) + "..."
            : post.content;

          item.appendChild(dateEl);
          item.appendChild(titleEl);
          item.appendChild(snippetEl);

          item.addEventListener("click", () => openDetail(post.id));
          itemsWrap.appendChild(item);
        });

        block.appendChild(label);
        block.appendChild(itemsWrap);
        timelineListEl.appendChild(block);
      });
    }

    // ======== ìƒì„¸ ë³´ê¸° ========
    function openDetail(id) {
      const post = posts.find(p => p.id === id);
      if (!post) return;

      detailTitle.textContent = post.title;
      detailDate.textContent = `ì‘ì„±ì¼ Â· ${formatDate(post.date || post.createdAt)}`;
      const created = new Date(post.createdAt);
      detailCreatedInfo.textContent = `ì €ì¥ ì‹œê°: ${formatDate(created)} ${created.toTimeString().slice(0, 5)}`;

      detailContent.innerHTML = escapeHtml(post.content).replace(/\n/g, "<br />");

      detailImages.innerHTML = "";
      if (post.images && post.images.length > 0) {
        detailImageCount.textContent = `ì‚¬ì§„ ${post.images.length}ì¥`;
        post.images.forEach(src => {
          const img = document.createElement("img");
          img.src = src;
          img.addEventListener("click", () => openImageModal(src));
          detailImages.appendChild(img);
        });
      } else {
        detailImageCount.textContent = "ì‚¬ì§„ ì—†ìŒ";
      }

      detailToEditorBtn.onclick = () => {
        editingPostId = null; // ë¹„ìŠ·í•œ ìƒˆ ê¸€
        titleInput.value = `[ë¹„ìŠ·í•œ ê¸°ë¡] ${post.title}`;
        contentInput.value = "";
        imageInput.value = "";
        dateInput.value = todayInputValue();
        todayInfo.textContent = getTodayLabel();
        showView("editor");
      };

      showView("detail");
    }

    // ======== ìˆ˜ì • ëª¨ë“œ ì‹œì‘ ========
    function startEdit(post) {
      editingPostId = post.id;
      titleInput.value = post.title;
      contentInput.value = post.content;
      imageInput.value = "";
      const d = post.date || post.createdAt || Date.now();
      dateInput.value = dateToInputValue(d);
      todayInfo.textContent = "ì´ ê¸€ì„ ìˆ˜ì •í•˜ëŠ” ì¤‘ì´ì•¼ âœï¸";
      showView("editor");
    }

    // ======== ìƒˆ ê¸€ / ìˆ˜ì • ì²˜ë¦¬ ========
    newPostBtn.addEventListener("click", () => {
      editingPostId = null;
      postForm.reset();
      dateInput.value = todayInputValue();
      todayInfo.textContent = getTodayLabel();
      showView("editor");
      titleInput.focus();
    });

    cancelBtn.addEventListener("click", () => {
      editingPostId = null;
      postForm.reset();
      showView("list");
    });

    // ë’¤ë¡œê°€ê¸° ë§í¬ë“¤
    backLinks.forEach(link => {
      link.addEventListener("click", () => {
        editingPostId = null;
        showView(link.dataset.back || "list");
      });
    });

    // ì´ë¯¸ì§€ íŒŒì¼ë“¤ì„ DataURL ë°°ì—´ë¡œ ë³€í™˜
    function readImages(files) {
      const arr = Array.from(files || []);
      if (arr.length === 0) return Promise.resolve([]);

      return Promise.all(
        arr.map(file => {
          return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.readAsDataURL(file);
          });
        })
      );
    }

    postForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = titleInput.value.trim();
      const content = contentInput.value.trim();
      const dateValue = dateInput.value;

      if (!title || !content || !dateValue) {
        alert("ì œëª©, ë‚ ì§œ, ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì¤˜!");
        return;
      }

      const selectedDate = new Date(dateValue + "T00:00:00");
      const dateMs = selectedDate.getTime();
      const files = imageInput.files;
      const imageDataUrls = await readImages(files);
      const now = Date.now();

      if (editingPostId !== null) {
        // ìˆ˜ì • ëª¨ë“œ
        const idx = posts.findIndex(p => p.id === editingPostId);
        if (idx !== -1) {
          const target = posts[idx];
          target.title = title;
          target.content = content;
          target.date = dateMs;
          // ìƒˆ ì‚¬ì§„ ì„ íƒí–ˆìœ¼ë©´ êµì²´, ì•„ë‹ˆë©´ ê¸°ì¡´ ìœ ì§€
          if (imageDataUrls.length > 0) {
            target.images = imageDataUrls;
          }
          posts[idx] = target;
          savePosts();
        }
      } else {
        // ìƒˆ ê¸€ ëª¨ë“œ
        const newPost = {
          id: now,
          title,
          content,
          images: imageDataUrls,
          createdAt: now,
          date: dateMs
        };
        posts.unshift(newPost);
        savePosts();
      }

      editingPostId = null;
      renderList();
      renderTimeline();

      postForm.reset();
      showView("list");
    });

    // ======== ê²€ìƒ‰ ê¸°ëŠ¥ ========
    searchInput.addEventListener("input", () => {
      currentSearch = searchInput.value;
      renderList();
      renderTimeline();
      updateListModeVisibility();
    });

    // ======== ë·° í† ê¸€ (ì¹´ë“œ / íƒ€ì„ë¼ì¸) ========
    toggleButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const mode = btn.dataset.mode;
        if (!mode || mode === currentListMode) return;
        currentListMode = mode;

        toggleButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        updateListModeVisibility();
      });
    });

    function updateListModeVisibility() {
      if (currentListMode === "grid") {
        postListEl.style.display = "grid";
        timelineListEl.style.display = "none";
      } else {
        postListEl.style.display = "none";
        timelineListEl.style.display = "block";
      }

      const filtered = getFilteredPosts();
      const hasPosts = filtered.length > 0;
      emptyStateEl.style.display = hasPosts ? "none" : "block";
    }

    // ======== ì´ˆê¸°í™” ========
    function init() {
      posts = loadPosts();
      renderList();
      renderTimeline();
      todayInfo.textContent = getTodayLabel();
      dateInput.value = todayInputValue();
      updateListModeVisibility();
      updateDDayBox();
    }

    init();
  </script>
</body>
</html>
